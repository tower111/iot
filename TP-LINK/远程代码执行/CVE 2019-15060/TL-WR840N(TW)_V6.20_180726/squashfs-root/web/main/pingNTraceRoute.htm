<script language="javascript" type="text/javascript">var test_conn;var wan_conn_name;var lan_conn_name;var ipping={};var tracert={};function is_domain(domain_string){var c;var ch="-.ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var i=0;i<domain_string.length;i++){c=domain_string.charAt(i);if(ch.indexOf(c)==-1){return false}}return true}function disNewLine(info,stat){var display_table=$.id("display_table");var newRow=display_table.insertRow(-1);var newCell=newRow.insertCell(-1);newCell.width="40px";$.h(newCell,"");newCell=newRow.insertCell(-1);newCell.width="1500px";if(""==stat){$.h(newCell,info)}else{$.h(newCell,blank+info)}newCell=newRow.insertCell(-1);newCell.width="128px";$.h(newCell,stat)}function clearTbl(){while($.id("display_table").rows.length>0){$.id("display_table").deleteRow(-1)}}function doIpping(){$.act(ACT_OP,ACT_OP_IPPING);if(!$.exe()){return}}function strstr(str,flag){var ret=str.search(flag);return ret}function startDiag(){var result;var icmpPkts;var pktSize;var pingtimeout;var printHeader=1;icmpPkts=parseInt($.id("l_ping_pkt").value,10);pktSize=parseInt($.id("l_ping_pkt_size").value,10);pingtimeout=parseInt($.id("l_ping_pkt_time").value,10);if($.id("l_addr").value==""){$.alert(ERR_DIAG_IP_ADDR);$.id("l_addr").focus();return}if(!is_domain($.id("l_addr").value)){$.alert(ERR_DIAG_IP_ADDR);$.id("l_addr").focus();return}if(isNaN(pktSize)||pktSize<0||pktSize>65500){$.alert(ERR_DIAG_PACKET_SIZE);$.id("l_ping_pkt_size").focus();return}if(isNaN(pingtimeout)||pingtimeout<1||pingtimeout>60){$.alert(ERR_DIAG_TIME_OUT);$.id("l_ping_pkt_time").focus();return}clearTbl();var aliasName=$.act(ACT_GET,L3_FORWARDING,null,null,["__ifAliasName"]);if($.exe()){$.alert(ERR_DIAG_EWAN_OFF);return}if(aliasName.__ifAliasName=="NO_INTERFACE"){$.alert(ERR_DIAG_EWAN_OFF);return}var isLanDomain=false;if($.id("l_addr").value=="tplinkwifi.net"||(INCLUDE_MULTIMODE_AP&&$.id("l_addr").value=="tplinkap.net")||(INCLUDE_MULTIMODE_RE&&$.id("l_addr").value=="tplinkrepeater.net")){isLanDomain=true}var lanIp;var lanSubMask;var ipList=$.act(ACT_GS,LAN_IP_INTF,null,null,["IPInterfaceIPAddress","IPInterfaceSubnetMask","__ifName"]);if(!$.exe()){lanIp=ipList[0].IPInterfaceIPAddress;lanSubMask=$.ip2num(ipList[0].IPInterfaceSubnetMask);lan_conn_name=ipList[0].__ifName}var dstIp=$.ip2num($.id("l_addr").value);if(isLanDomain||(dstIp!=false&&((dstIp&lanSubMask)^($.ip2num(lanIp)&lanSubMask))==0)){test_conn=lan_conn_name}else{test_conn=wan_conn_name}if($.id("ipping").checked){if(isNaN(icmpPkts)||icmpPkts<1||icmpPkts>50){$.alert(ERR_DIAG_PING_COUNT);$.id("l_ping_pkt").focus();return}ipping=$.act(ACT_GET,IPPING_DIAG,null,null,["dataBlockSize","timeout","numberOfRepetitions","host","X_TP_ConnName","diagnosticsState"]);if(!$.exe()){ipping.diagnosticsState="Requested";ipping.dataBlockSize=parseInt($.id("l_ping_pkt_size").value,10);ipping.timeout=parseInt($.id("l_ping_pkt_time").value,10);ipping.numberOfRepetitions=parseInt($.id("l_ping_pkt").value,10);ipping.host=isLanDomain?lanIp:$.id("l_addr").value;ipping.X_TP_ConnName=test_conn;pktSize=parseInt($.id("l_ping_pkt_size").value,10)+8;pingtimeout=parseInt($.id("l_ping_pkt_time").value,10);$.act(ACT_SET,IPPING_DIAG,null,null,ipping);if(!$.exe()){$.id("testButton").disabled=true;$.addLoading($.id("testButton"));var gotResult=1;var i=1;$.auto(function(){ipping=$.act(ACT_GET,IPPING_DIAG,null,null,null);if(!$.exe()){if(i>icmpPkts){result="";disNewLine(result,"");result="---"+ipping.X_TP_IPAddress+" ping statistics ---";disNewLine(result,"");result=ipping.numberOfRepetitions+" packets transmitted, "+ipping.successCount+" packets received,"+Math.round(ipping.failureCount*100/ipping.numberOfRepetitions)+"% packet loss";disNewLine(result,"");if(ipping.minimumResponseTime!=65535){result="round-trip min/avg/max = "+ipping.minimumResponseTime/1000+"/"+ipping.averageResponseTime/1000+"/"+ipping.maximumResponseTime/1000+" ms";disNewLine(result,"")}$.id("testButton").disabled=false;$.removeLoading($.id("testButton"));return false}if(gotResult){$.act(ACT_OP,ACT_OP_IPPING);if(!$.exe()){gotResult=0;return true}return false}if(printHeader){result="PING "+ipping.host;if($.ifip(ipping.host,true)==0){result=result+" ("+ipping.host+"): "+ipping.dataBlockSize+" data bytes";disNewLine(result,"");result="";disNewLine(result,"");printHeader=0}else{if($.ifip(ipping.X_TP_IPAddress,true)==0){result=result+" ("+ipping.X_TP_IPAddress+"): "+ipping.dataBlockSize+" data bytes";disNewLine(result,"");result="";disNewLine(result,"");printHeader=0}}}if("Error_CannotResolveHostName"==ipping.diagnosticsState){result="PING: unknown host: "+ipping.host;disNewLine(result,"");$.id("testButton").disabled=false;$.removeLoading($.id("testButton"));return false}else{if("Requested"==ipping.diagnosticsState){gotResult=0;return true}else{if("None"==ipping.diagnosticsState){gotResult=1;var res=pktSize+" bytes from "+ipping.X_TP_IPAddress+": icmp_seq="+i+" ttl=128 time="+ipping.X_TP_ResponseTime/1000+" ms";disNewLine(res,"");res="";i++}else{if("Complete"==ipping.diagnosticsState){if(strstr(ipping.X_TP_Result,"Request timed out.")!=-1){result="Request timed out.";disNewLine(result,"")}else{result=pktSize+" bytes from "+ipping.X_TP_IPAddress+": icmp_seq="+i+" ttl=128 time="+ipping.X_TP_ResponseTime/1000+" ms";disNewLine(result,"")}result="";disNewLine(result,"");result="---"+ipping.X_TP_IPAddress+" ping statistics ---";disNewLine(result,"");result=ipping.numberOfRepetitions+" packets transmitted, "+ipping.successCount+" packets received,"+Math.round(ipping.failureCount*100/ipping.numberOfRepetitions)+"% packet loss";disNewLine(result,"");if(ipping.minimumResponseTime!=65535){result="round-trip min/avg/max = "+ipping.minimumResponseTime/1000+"/"+ipping.averageResponseTime/1000+"/"+ipping.maximumResponseTime/1000+" ms";disNewLine(result,"")}$.id("testButton").disabled=false;$.removeLoading($.id("testButton"));return false}else{if("Error_Internal"==ipping.diagnosticsState){gotResult=1;disNewLine(ipping.X_TP_Result,"")}else{gotResult=1;disNewLine(ipping.X_TP_Result,"");i++}}}}}ipping.diagnosticsState="Requested";ipping.X_TP_Result="";$.act(ACT_SET,IPPING_DIAG,null,null,["X_TP_Result=","diagnosticsState=Requested"]);if(!$.exe()){}}},500)}}}else{if($.id("traceroute").checked){var maxHop;var lqtmp;maxHop=parseInt($.id("l_tr_hop").value,10);if(isNaN(maxHop)||maxHop<1||maxHop>30){$.alert(ERR_DIAG_TTL);$.id("l_tr_hop").focus();return}tracert=$.act(ACT_GET,TRACEROUTE_DIAG,null,null,["maxHopCount","timeout","numberOfTries","host","dataBlockSize","X_TP_ConnName","diagnosticsState","X_TP_HopSeq"]);var HopCount=0;var tmp;var loopTime=500;var traceHost;var tpktsize;if(!$.exe()){tracert.diagnosticsState="Requested";tracert.host=isLanDomain?lanIp:$.id("l_addr").value;tracert.dataBlockSize=64;tracert.timeout=5;tracert.numberOfTries=1;tracert.maxHopCount=parseInt($.id("l_tr_hop").value,10);tracert.X_TP_ConnName=test_conn;tracert.X_TP_HopSeq=0;HopCount=parseInt($.id("l_tr_hop").value,10);traceHost=isLanDomain?lanIp:$.id("l_addr").value;tpktsize=64;maxHop=parseInt($.id("l_tr_hop").value,10);$.act(ACT_SET,TRACEROUTE_DIAG,null,null,tracert);if(!$.exe()){$.id("testButton").disabled=true;$.addLoading($.id("testButton"));var i=0;$.act(ACT_OP,ACT_OP_TRACERT);if($.exe()){$.id("testButton").disabled=false;$.removeLoading($.id("testButton"));return}$.auto(function(){tracert=$.act(ACT_GET,TRACEROUTE_DIAG,null,null,["diagnosticsState","X_TP_HopSeq","X_TP_Result"]);if(!$.exe()){if((tracert.X_TP_HopSeq==0)&&(tracert.X_TP_Result!="")&&printHeader){printHeader=0;if(strstr(tracert.X_TP_Result,"traceroute")>=0){disNewLine(tracert.X_TP_Result,"");++tracert.X_TP_HopSeq;loopTime=500;tracert.X_TP_Result="";$.act(ACT_SET,TRACEROUTE_DIAG,null,null,tracert);if(!$.exe()){return true}}else{if(tracert.diagnosticsState=="Complete"||tracert.diagnosticsState=="None"||tracert.diagnosticsState=="Requested"){lqtmp=tracert.X_TP_Result}var ip=$.act(ACT_GET,TRACEROUTE_DIAG,null,null,["X_TP_IPAddress"]);if(!$.exe()){result="traceroute to "+traceHost+" ("+ip.X_TP_IPAddress+"), "+maxHop+" hops max, "+tpktsize+" byte packets";disNewLine(result,"");disNewLine(lqtmp,"");++tracert.X_TP_HopSeq;loopTime=500;tracert.X_TP_Result="";$.act(ACT_SET,TRACEROUTE_DIAG,null,null,tracert);if(!$.exe()){return true}}}}if((tracert.diagnosticsState!="Requested")&&(tracert.diagnosticsState!="None")&&(tracert.diagnosticsState!="Complete")){if("Error_CannotResolveHostName"==tracert.diagnosticsState){result=traceHost+": Name or service not know";disNewLine(result,"");$.id("testButton").disabled=false;$.removeLoading($.id("testButton"));return false}disNewLine(tracert.X_TP_Result,"");tracert.X_TP_Result="";$.act(ACT_SET,TRACEROUTE_DIAG,null,null,tracert);if(!$.exe()){}$.id("testButton").disabled=false;$.removeLoading($.id("testButton"));return false}else{if(tracert.diagnosticsState=="Complete"){disNewLine(tracert.X_TP_Result,"");tracert.X_TP_Result="";$.act(ACT_SET,TRACEROUTE_DIAG,null,null,tracert);if(!$.exe()){}$.id("testButton").disabled=false;$.removeLoading($.id("testButton"));return false}}if(tracert.X_TP_Result!=""){disNewLine(tracert.X_TP_Result,"");loopTime=500;++tracert.X_TP_HopSeq;tracert.X_TP_Result="";$.act(ACT_SET,TRACEROUTE_DIAG,null,null,tracert);if(!$.exe()){return true}}loopTime+=500;if(tracert.X_TP_HopSeq==HopCount){disNewLine(tracert.X_TP_Result,"");$.id("testButton").disabled=false;$.removeLoading($.id("testButton"));return false}if(loopTime>=150000){result="traceroute to ("+traceHost+") failed!";disNewLine(result,"");$.id("testButton").disabled=false;$.removeLoading($.id("testButton"));return false}}},500)}}}}}function diagnosticInit(){var index=0;var i=0;var aliasName=$.act(ACT_GET,L3_FORWARDING,null,null,["__ifAliasName"]);$.id("ipping").checked=true;$.id("l_addr").disabled=false;$.id("l_ping_pkt").disabled=false;$.id("l_ping_pkt_size").disabled=false;$.id("l_ping_pkt_time").disabled=false;$.id("l_tr_hop").disabled=true;if(!$.exe()){wan_conn_name=aliasName.__ifAliasName}}function changeToolParams(){if($.id("ipping").checked){$.id("l_tr_hop").disabled=true;$.id("l_ping_pkt").disabled=false;$.id("l_ping_pkt_size").disabled=false;$.id("l_ping_pkt_time").disabled=false}else{if($.id("traceroute").checked){$.id("l_tr_hop").disabled=false;$.id("l_ping_pkt").disabled=true;$.id("l_ping_pkt_size").disabled=true;$.id("l_ping_pkt_time").disabled=true}}};</script>
<p class="et T" id="et">Diagnose Internet Connection Tools</p>
<div class="con1 M">
	<p class="ct"></p>
	<p class="bl"></p>
	<p class="st T XL" id="t_param">Diagnostic Parameters</p>
	<div class="con2">
		<p><b class="item L T" id="t_test_method">Choose the test operation: </b>
		<input name="operation"  id="ipping" type="radio" onclick="changeToolParams()"/><span class="T T_ipping" id="t_ipping">Ping</span>
		<input name="operation" id="traceroute"  type="radio" onclick="changeToolParams()"/><span class="T T_tracert" id="t_tracert">Traceroute</span>
		<input type="button" id="testButton" class="button L T T_start" value="Start" onClick="startDiag()"/>
		</p>
		<p class="br"></p>
		<p><b class="item L2 T T_addr" id="t_addr">IP address/Domain name:</b><input type="text" class="text" id="l_addr" value="" size="25" maxlength="63" /></p>
		<p><b class="item L T T_ping_pkt" id="t_ping_pkt">The number of ping/trace packets:</b><input type="text" class="text" id="l_ping_pkt" value="4" size="7" maxlength="2" onkeyup="this.value=this.value.replace(/[^0-9]/,'')"/><span class="T T_note1"> ping(1 - 50)</span></p>
		<p><b class="item L T T_ping_pkt_size" id="t_ping_pkt_size">The size of a ping/trace packet:</b><input type="text" class="text" id="l_ping_pkt_size" value="64" size="7" maxlength="5" onkeyup="this.value=this.value.replace(/[^0-9]/,'')"/><span id="t_note2"> (0 - 65500 Bytes)</span></p>
		<p><b class="item L T T_ping_timeout" id="t_ping_timeout">The timeout for ping/trace test at a time:</b><input type="text" class="text" size="7" maxlength="4" id="l_ping_pkt_time" value="1" onkeyup="this.value=this.value.replace(/[^0-9]/,'')"/><span id="t_note3"> (1 - 60 Seconds)</span></p>
		<p><b class="item L T T_trace_hop" id="t_trace_hop">The max hop for traceroute test:</b><input type="text" class="text" size="7" maxlength="4" id="l_tr_hop" value="20" onkeyup="this.value=this.value.replace(/[^0-9]/,'')"/><span class="T T_note2"> (1 - 30)</span></p>
		<p class="br"></p>
	</div>
	<p class="st T" id="t_result">Diagnostic Results</p>
	<div class="M tbody bdr ts" style="height: 320px; overflow-y: scroll; background-color: beige">
		<table id="display_table" cellspacing="0" cellpadding="0" class="tbody M"></table>
	</div>
	<p class="bl"></p>
</div>
<script language="javascript" type="text/javascript">$.loadHelpFrame("PingHelpRpm.htm");diagnosticInit();</script>
